using EmrCloudApi.Constants;
using EmrCloudApi.Presenters.FlowSheet;
using EmrCloudApi.Requests.FlowSheet;
using EmrCloudApi.Responses;
using EmrCloudApi.Responses.FlowSheet;
using Microsoft.AspNetCore.Mvc;
using UseCase.Core.Sync;
using UseCase.FlowSheet.GetList;
using UseCase.FlowSheet.GetTooltip;
using UseCase.FlowSheet.Upsert;

namespace EmrCloudApi.Controller
{
    [Route("api/[controller]")]
    public class FlowSheetController : BaseParamControllerBase
    {
        private readonly UseCaseBus _bus;
        public FlowSheetController(UseCaseBus bus, IHttpContextAccessor httpContextAccessor) : base(httpContextAccessor)
        {
            _bus = bus;
        }

        [HttpGet(ApiPath.GetList + "FlowSheet")]
        public ActionResult<Response<GetListFlowSheetResponse>> GetListFlowSheet([FromQuery] GetListFlowSheetRequest inputData)
        {

            var watch = System.Diagnostics.Stopwatch.StartNew();
            watch.Start();
            var input = new GetListFlowSheetInputData(HpId, inputData.PtId, inputData.SinDate, inputData.RaiinNo, inputData.IsHolidayOnly, 0, 0, false);
            var output = _bus.Handle(input);
            var presenter = new GetListFlowSheetPresenter();
            presenter.Complete(output);

            var result = new ActionResult<Response<GetListFlowSheetResponse>>(presenter.Result);
            watch.Stop();
            Console.WriteLine("TimeLog_Flowsheet" + watch.ElapsedMilliseconds);
            return result;
        }

        [HttpGet(ApiPath.GetList + "Holiday")]
        public ActionResult<Response<GetListHolidayResponse>> GetListHoliday([FromQuery] GetListHolidayRequest inputData)
        {

            var input = new GetListFlowSheetInputData(HpId, 0, 0, 0, true, inputData.HolidayFrom, inputData.HolidayTo, false);
            var output = _bus.Handle(input);
            var presenter = new GetListHolidayPresenter();
            presenter.Complete(output);

            return new ActionResult<Response<GetListHolidayResponse>>(presenter.Result);
        }

        [HttpGet(ApiPath.GetList + "RaiinMst")]
        public ActionResult<Response<GetListRaiinMstResponse>> GetListRaiinMst([FromQuery] GetListRaiinMstRequest inputData)
        {

            var input = new GetListFlowSheetInputData(HpId, 0, 0, 0, false, 0, 0, true);
            var output = _bus.Handle(input);
            var presenter = new GetListRaiinMstPresenter();
            presenter.Complete(output);

            return new ActionResult<Response<GetListRaiinMstResponse>>(presenter.Result);
        }

        [HttpPost(ApiPath.Upsert)]
        public ActionResult<Response<UpsertFlowSheetResponse>> Upsert([FromBody] UpsertFlowSheetRequest inputData)
        {
            var input = new UpsertFlowSheetInputData(inputData.Items.Select(i => new UpsertFlowSheetItemInputData(
                                                        i.RainNo,
                                                        i.PtId,
                                                        i.SinDate,
                                                        i.TagNo,
                                                        i.Cmt
                                                    )).ToList(),
                                                    HpId,
                                                    UserId
                                                    );
            var output = _bus.Handle(input);
            var presenter = new UpsertFlowSheetPresenter();
            presenter.Complete(output);

            return new ActionResult<Response<UpsertFlowSheetResponse>>(presenter.Result);
        }

        [HttpGet(ApiPath.GetToolTip)]
        public ActionResult<Response<GetFlowSheetTooltipResponse>> GetToolTip([FromQuery] GetFlowSheetTooltipRequest inputData)
        {

            var input = new GetTooltipInputData(HpId, inputData.PtId, inputData.SinDate, inputData.StartDate, inputData.EndDate, inputData.IsAll);
            var output = _bus.Handle(input);
            var presenter = new GetFlowSheetTooltipPresenter();
            presenter.Complete(output);

            return new ActionResult<Response<GetFlowSheetTooltipResponse>>(presenter.Result);
        }
    }
}
